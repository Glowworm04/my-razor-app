@page
@model InternerShop.Pages.Cart.IndexModel
@{
    ViewData["Title"] = "Корзина покупок";
}

<div class="container">
    <h1>Корзина покупок</h1>

    @if (Model.CartItems.Any())
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Товары в корзине</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var item in Model.CartItems)
                        {
                            <div class="row mb-3 border-bottom pb-3">
                                <div class="col-md-2">
                                    @if (item.Product.ProductImages.Any())
                                    {
                                        <img src="@item.Product.ProductImages.First().ImageUrl"
                                             class="img-fluid"
                                             alt="@item.Product.ProductImages.First().AltText"
                                             style="height: 80px; object-fit: cover;">
                                    }
                                    else
                                    {
                                        <img src="/images/placeholder.jpg"
                                             class="img-fluid"
                                             alt="Нет изображения"
                                             style="height: 80px; object-fit: cover;">
                                    }
                                </div>
                                <div class="col-md-6">
                                    <h6>@item.Product.Name</h6>
                                    <p class="text-muted small mb-1">@item.Product.Category.Name</p>
                                    <p class="text-primary fw-bold">@item.Product.Price.ToString("C")</p>
                                </div>
                                <div class="col-md-2">
                                    <form method="post" asp-page-handler="UpdateQuantity">
                                        <input type="hidden" name="cartItemId" value="@item.CartItemId" />
                                        <input type="number" class="form-control form-control-sm"
                                               name="quantity" value="@item.Quantity"
                                               min="1" max="@item.Product.StockQuantity"
                                               onchange="this.form.submit()">
                                    </form>
                                </div>
                                <div class="col-md-2 text-end">
                                    <p class="fw-bold">@((item.Quantity * item.Product.Price).ToString("C"))</p>
                                    <form method="post" asp-page-handler="RemoveItem">
                                        <input type="hidden" name="cartItemId" value="@item.CartItemId" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Итого</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Товары (@Model.CartItems.Sum(i => i.Quantity) шт.):</span>
                            <span>@Model.CartItems.Sum(i => i.Quantity * i.Product.Price).ToString("C")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Доставка:</span>
                            <span class="text-success">Бесплатно</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Общая сумма:</strong>
                            <strong class="text-primary">@Model.CartItems.Sum(i => i.Quantity * i.Product.Price).ToString("C")</strong>
                        </div>

                        @if (User.Identity.IsAuthenticated)
                        {
                            <a href="/Order/Checkout" class="btn btn-primary w-100 btn-lg">Оформить заказ</a>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <p>Для оформления заказа необходимо <a href="/Identity/Account/Login">войти</a> в систему.</p>
                            </div>
                        }

                        <div class="mt-3 text-center">
                            <a href="/Catalog" class="btn btn-outline-secondary">Продолжить покупки</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
            <h3>Ваша корзина пуста</h3>
            <p class="text-muted">Добавьте товары из каталога, чтобы сделать заказ.</p>
            <a href="/Catalog" class="btn btn-primary btn-lg">Перейти в каталог</a>
        </div>
    }
</div>
